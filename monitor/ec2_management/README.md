# ec2 and ebs management mennual
### 이 문서는 aws의 instance 및 ebs 자원을 관리하기 위한 설명서입니다.


## 1. 파일 소개
### aws_ec2_report_to_slack.py
- 서울 리전의 람다 함수인 `usage_ec2_report` 의 파일입니다.
- 서울 리전의 이벤트 브릿지인 `usage-EC2-morning` 과 `usage-EC2-night` 가 트리거로 존재합니다.
- 매일 오전 8시 32분과 오후 10시에 실행 중이거나 정지해 둔 인스턴스의 목록을 슬랙으로 전송합니다.
- 또한 인스턴스와 밀접한 관계가 있는 볼륨 중 인스턴스와 연결되어 있지 않은 목록을 추려내어 슬랙으로 전송합니다.
- 하루에 2번씩 실행되는 함수이기에 에러가 발생할 시 빠른 디버깅을 위해 `slack_msg_sender` 의 `send_slack_message` 를 이용하여 에러메세지를 전송합니다.


### aws_snapshot_cleaning.py
- 서울 리전의 람다 함수인 `usage_snapshot_cleaning` 의 파일입니다.
- 이 파일은 수동으로 실행됩니다. (자세한 작동 방법은 이 설명서의 `2. 파일 실행` 을 확인하시길 바랍니다.)
- 계정에 존재하는 특이점 없는 스냅샷을 모두 삭제합니다.
- 볼륨과 연결되어 있는 스냅샷, AMI 구성을 위한 스냅샷, 백업을 위해 Name Tag를 붙여둔 스냅샷을 제외하고 모두 삭제되는 것에 유의하십시오.
- 정리한 내용을 슬랙으로 전송한 후 종료합니다.


## 2. 파일 실행
### a. usage_ec2_report
1. 정상적인 실행
    - 제대로 실행될 경우 슬랙으로 현재 실행 중인 인스턴스와 정지해둔 인스턴스의 목록을 확인할 수 있습니다.
2. 비정상적인 실행
    - 실행 중 오류가 생길 경우 슬랙으로 에러 메세지를 전송합니다.
    - 이때 처음 에러가 발생한 곳부터 여러 에러 메세지가 전송되었을 수 있습니다.
    - 제일 처음 전송된 에러 메세지부터 확인하며 디버깅합니다.


### b. usage_snapshot_cleaning
1. 함수 실행 전
    - 함수를 실행하기 전 삭제하길 원치 않는 스냅샷에 모두 Name Tag를 설정하십시오.
    - 이 함수를 실행하면, 특이점 없는 일반 스냅샷이 모든 리전에서 사라진다는 것을 명심하십시오.
    - 함수 실행 시 삭제된 스냅샷을 복원하는 것이 어렵습니다.

2. 함수 실행 방법
    - aws 계정 내에 서울 리전의 lambda 목록을 확인합니다.
    - `usage_snapshot_cleaning` 을 찾아 클릭합니다.
    - Code source 창에서 `test` 버튼을 눌러 함수를 실행합니다.

3. 함수 실행 후
    - 환경 변수로 설정해둔 슬랙으로 메세지가 전송되어야 합니다.
    - 실행한 창에서 성공적으로 끝마치었다는 메세지를 확인합니다.
    - 메세지를 확인하지 못하였다면 작업에 이상이 생겼을 수 있으니 실행 로그를 확인하시길 바랍니다.



# 주의 사항
1. 설정해둔 aws 내의 함수에 변경 사항이 생기면 실행이 원활하지 않을 수 있습니다.
2. 스냅샷 정리 파일은 수동으로 실행하는 파일입니다. 언제든 이벤트 브릿지를 설정하여 자동화할 수 있습니다.